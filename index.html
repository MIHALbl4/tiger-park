<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7271aeed-6ae5-46a4-bb1e-71085eec111c&lang=ru_RU"
        type="text/javascript">
        </script>
    <link href="./dist/output.css" rel="stylesheet">
</head>

<body>
    <div>
        <select name="entity">
            <option value="0">Физическое лицо</option>
            <option value="1">Юридическое лицо</option>
        </select>
    </div>


    <div class="block m-3">
        <label for="carFrom">Машина из:</label>
        <select name="carFrom" id="carFrom">
            <option value="0">Севастополя</option>
            <option value="1">Симферополя</option>
        </select>
    </div>
    Перевозка
    <div class="block">
        <select name="carMode" id="carMode">
            <option value="0">Внутри города(пригородные районы)</option>
            <option value="1">Между городами</option>
        </select>
    </div>
    <div class="block">
        В:
        <div name="toPosition">
        </div>
    </div>

    <div id="map" style="width: 600px; height: 400px" class=""></div>
</body>

<script src="./particles.js"></script>
<script type="text/javascript">
    let entity = 0;
    let carMode = 0;
    let carFrom = 0;
    let from = undefined;

    let length = undefined;
    let duration = undefined;
    let points = undefined;

    insertValues();

    document.querySelector('select[name="entity"]').addEventListener('change', function () {
        entity = document.querySelector('select[name="entity"]').value;
        insertValues();
    });

    document.querySelector('select[name="carMode"]').addEventListener('change', function () {
        carMode = document.querySelector('select[name="carMode"]').value;
        insertValues();
    });

    document.querySelector('select[name="carFrom"]').addEventListener('change', function () {
        carFrom = document.querySelector('select[name="carFrom"]').value;
        insertValues();
    });

    document.querySelector('select[name="carFrom"]').addEventListener('change', function () {
        carFrom = document.querySelector('select[name="carFrom"]').value;
        insertValues();
    });

    function insertValues() {
        from = undefined;
        document.getElementById("map").innerHTML = "";
        if (entity != undefined && carMode != undefined && carFrom != undefined) {
            if (entity == 0) {
                if (carFrom == 0) {
                    if (carMode == 0) document.querySelector('div[name="toPosition"]').innerHTML = genTextHTML(p0_0);
                    if (carMode == 1) document.querySelector('div[name="toPosition"]').innerHTML = genTextHTML(p0_1);
                }
                if (carFrom == 1) {
                    if (carMode == 0) document.querySelector('div[name="toPosition"]').innerHTML = genTextHTML(p1_0);
                    if (carMode == 1) document.querySelector('div[name="toPosition"]').innerHTML = genTextHTML(p1_1);
                }
            }

            document.querySelector('select[name="from"]').addEventListener('change', function () {
                document.getElementById("map").innerHTML = "";
                from = document.querySelector('select[name="from"]').value;
                startProc();
            });
        }
        // fetch("https://api.telegram.org/bot" + "6262342330:AAH2kS4xyeF0GjqDG_FLk3ufYHVTpdP3npA" + "/sendMessage?chat_id=" + -1001284528422 + "&text=" + "New%20Message:%20" + "message");
    }

    function startProc() {
        let carFity = 'Севастополь'
        if (carFrom == 1) car_city = 'Симферополь'

        let fromCity = document.querySelector('select[name="from"]');
        fromCity = fromCity.options[fromCity.selectedIndex].text;

        initMap(fromCity, [fromCity]);
    }

    function initMap(centerCity, wayPoints) {
        ymaps.ready(function () {
            var myMap;
            ymaps.geocode(centerCity).then(function (res) {
                myMap = new ymaps.Map('map', {
                    center: res.geoObjects.get(0).geometry.getCoordinates(),
                    zoom: 11,
                    controls: []
                });

                var searchControl = new ymaps.control.SearchControl({
                    options: {
                        provider: 'yandex#search'
                    }
                });

                myMap.controls.add(searchControl);


                var multiRoute = new ymaps.multiRouter.MultiRoute({
                    referencePoints: wayPoints
                }, {
                    editorDrawOver: false,
                    editorMidPointsType: "way",
                    reverseGeocoding: false
                });

                multiRoute.editor.start({
                    addWayPoints: true,
                    removeWayPoints: true,
                });

                multiRoute.events.add('update', async function () {
                    if (multiRoute.getActiveRoute() != null) {

                        length = multiRoute.getActiveRoute().properties.get("distance");
                        duration = multiRoute.getActiveRoute().properties.get('duration');
                        points = multiRoute.getWayPoints().toArray();

                        console.log(length);
                        console.log(duration);

                        let position = undefined;
                        calc();
                    }
                });

                myMap.geoObjects.add(multiRoute);
            });
        });
    }

    function calc() {
        let price = 0;
        price += Number(from);
        price += Number(length.value) / 1000 * 50
        console.log(price);
        return price;
    }
</script>

</html>