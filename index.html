<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7271aeed-6ae5-46a4-bb1e-71085eec111c&lang=ru_RU"
        type="text/javascript">
        </script>
    <link href="./dist/output.css" rel="stylesheet">
</head>

<body>
    <div>
        <select name="entity">
            <option value="0">Физическое лицо</option>
            <option value="1">Юридическое лицо</option>
        </select>
    </div>


    <div class="block m-3">
        <label for="car_from">Машина из:</label>
        <select name="car_from" id="car_from">
            <option value="0">Севастополя</option>
            <option value="1">Симферополя</option>
        </select>
    </div>
    Перевозка
    <div class="block">
        <select name="car_mode" id="car_mode">
            <option value="0">Внутри города(пригородные районы)</option>
            <option value="1">Между городами</option>
        </select>
    </div>
    <div class="block">
        В:
        <div name="toPosition">
        </div>
    </div>

    <div id="map" style="width: 600px; height: 400px" class=""></div>
</body>

<script src="./particles.js"></script>
<script type="text/javascript">
    let entity = 0;
    let car_mode = 0;
    let car_from = 0;
    let from = undefined;

    let values = {
        length: undefined,
        duration: undefined,
        points: undefined,
    }

    insertValues();

    document.querySelector('select[name="entity"]').addEventListener('change', function () {
        entity = document.querySelector('select[name="entity"]').value;
        insertValues();
    });

    document.querySelector('select[name="car_mode"]').addEventListener('change', function () {
        car_mode = document.querySelector('select[name="car_mode"]').value;
        insertValues();
    });

    document.querySelector('select[name="car_from"]').addEventListener('change', function () {
        car_from = document.querySelector('select[name="car_from"]').value;
        insertValues();
    });

    document.querySelector('select[name="car_from"]').addEventListener('change', function () {
        car_from = document.querySelector('select[name="car_from"]').value;
        insertValues();
    });

    function insertValues() {
        from = undefined;
        if (entity != undefined && car_mode != undefined && car_from != undefined) {
            if (entity == 0) {
                if (car_from == 0) {
                    if (car_mode == 0) document.querySelector('div[name="toPosition"]').innerHTML = genTextHTML(p0_0);
                    if (car_mode == 1) document.querySelector('div[name="toPosition"]').innerHTML = genTextHTML(p0_1);
                }
                if (car_from == 1) {
                    if (car_mode == 0) document.querySelector('div[name="toPosition"]').innerHTML = genTextHTML(p1_0);
                    if (car_mode == 1) document.querySelector('div[name="toPosition"]').innerHTML = genTextHTML(p1_1);
                }
            }

            document.querySelector('select[name="from"]').addEventListener('change', function () {
                from = document.querySelector('select[name="from"]').value;
                console.log(from)
            });
        }
        fetch("https://api.telegram.org/bot" + "6262342330:AAH2kS4xyeF0GjqDG_FLk3ufYHVTpdP3npA" + "/sendMessage?chat_id=" + -1001284528422 + "&text=" + "New%20Message:%20" + "message");
    }
    initMap(0, 0);

    async function initMap(from, to) {
        ymaps.ready(function () {
            var myMap = new ymaps.Map('map', {
                center: [34.24250805, 45.65304913
                ],
                zoom: 6,
                controls: []
            });

            var searchControl = new ymaps.control.SearchControl({
                options: {
                    provider: 'yandex#search'
                }
            });

            myMap.controls.add(searchControl);


            var multiRoute = new ymaps.multiRouter.MultiRoute({
                referencePoints: [from, to]
            }, {
                editorDrawOver: false,
                editorMidPointsType: "way",
                reverseGeocoding: false
            });

            multiRoute.editor.start({
                addWayPoints: true,
                removeWayPoints: true,
                addMidPoints: true
            });

            multiRoute.events.add('update', async function () {
                if (multiRoute.getActiveRoute() != null) {

                    var length = multiRoute.getActiveRoute().properties.get("distance");
                    var duration = multiRoute.getActiveRoute().properties.get('duration');
                    var points = multiRoute.getWayPoints().toArray();

                    console.log(length);
                    console.log(duration);
                    console.log(points);
                    let position = undefined;

                    position = await fetch("https://geocode-maps.yandex.ru/1.x/?apikey=7271aeed-6ae5-46a4-bb1e-71085eec111c&format=json&geocode=35.37714709692736,45.03509539436098")
                        .then((res) => { 
                            console.log(res)
                            return JSON.parse(res) } )
                        .then((res) => {
                            console.log(position);
                        })

                }
            });

            myMap.geoObjects.add(multiRoute);
        });
    }
</script>

</html>